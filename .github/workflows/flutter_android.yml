name: Flutter Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # üëà –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # üëà –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
    
    env:
      # üëá –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
      GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
      FLUTTER_ROOT: /opt/hostedtoolcache/flutter
    
    steps:
    # 1. –ö–æ–¥
    - uses: actions/checkout@v4
    
    # 2. –ö–≠–® Gradle - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      id: gradle-cache
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # 3. –ö–≠–® Flutter SDK –∏ pub cache
    - name: Cache Flutter
      uses: actions/cache@v3
      id: flutter-cache
      with:
        path: |
          ${{ env.FLUTTER_ROOT }}
          ~/.pub-cache
        key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.lock') }}
    
    # 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle  # üëà –ö—ç—à –¥–ª—è Gradle
    
    # 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.3'  # üëà –§–∏–∫—Å–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é
        channel: 'stable'
        cache: true
        cache-key: flutter-cache-${{ hashFiles('pubspec.lock') }}
        cache-path: ${{ env.FLUTTER_ROOT }}
    
    # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    - name: Flutter doctor
      run: flutter doctor -v
    
    # 7. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Flutter
    - name: Get Flutter dependencies
      run: flutter pub get
    
    # 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    - name: Analyze code
      run: |
        flutter analyze --no-pub --no-fatal-infos || true
    
    # 9. –¢–µ—Å—Ç—ã
    - name: Run tests
      run: |
        flutter test --no-pub || echo "Tests might have failed, continuing build"
    
    # 10. –°–±–æ—Ä–∫–∞ AAB (–¥–ª—è Google Play) - –±—ã—Å—Ç—Ä–µ–µ —á–µ–º APK
    - name: Build Android App Bundle
      run: |
        # –°–Ω–∞—á–∞–ª–∞ —Å–±–æ—Ä–∫–∞ debug –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        flutter build apk --debug --no-pub
        
        # –û—Å–Ω–æ–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ release
        flutter build appbundle \
          --release \
          --no-tree-shake-icons \
          --split-debug-info=/tmp/symbols/ \
          --obfuscate \
          --no-pub
      env:
        # üëá –û—Ç–∫–ª—é—á–∞–µ–º signing –¥–ª—è CI (—É—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É)
        JAVA_OPTS: "-Xmx4096m -XX:+UseG1GC"
    
    # 11. –°–±–æ—Ä–∫–∞ APK –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    - name: Build APK for testing
      run: |
        flutter build apk \
          --release \
          --split-per-abi \
          --no-pub \
          --no-obfuscate  # üëà –û—Ç–∫–ª—é—á–∞–µ–º –æ–±—Ñ—É—Å–∫–∞—Ü–∏—é –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    
        # 12. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4 # <-- –î–µ—Ñ–∏—Å–∞ –ø–µ—Ä–µ–¥ 'uses' –ù–ï–¢
      with:
        name: flutter-builds
        path: |
          build/app/outputs/bundle/release/*.aab
          build/app/outputs/apk/release/*.apk
        retention-days: 14
    
    # 13. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram/Discord
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì¶ Artifacts uploaded"
    
    # 14. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—É–¥–∞—á–µ
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Build failed!"
        echo "Check logs for details"
