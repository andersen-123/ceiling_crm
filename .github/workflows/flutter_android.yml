name: Flutter Android Build
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.3'
      
      - name: Debug - Show Environment
        run: |
          echo "=== Информация о среде ==="
          flutter --version
          java --version
          echo "Kotlin версия в build.gradle:"
          grep "kotlin_version" android/build.gradle || echo "Не найдено"
          echo "Android Gradle Plugin:"
          grep "com.android.tools.build:gradle" android/build.gradle || echo "Не найдено"
      
      - name: Pre-download Gradle
        run: |
          echo "Явная загрузка Gradle..."
          mkdir -p ~/.gradle/wrapper/dists
          
          # Пытаемся скачать Gradle с резервными источниками
          for url in \
            "https://github.com/gradle/gradle-distributions/releases/download/v8.5.0/gradle-8.5-all.zip" \
            "https://downloads.gradle-dn.com/distributions/gradle-8.5-all.zip" \
            "https://services.gradle.org/distributions/gradle-8.5-all.zip"
          do
            echo "Попытка скачать с: $url"
            if curl -L --retry 3 --max-time 300 -o /tmp/gradle.zip "$url"; then
              echo "Успешно скачали Gradle"
              unzip -q /tmp/gradle.zip -d ~/.gradle/wrapper/dists/
              GRADLE_DIR=$(find ~/.gradle/wrapper/dists -name "gradle-8.5*" -type d | head -1)
              if [ -n "$GRADLE_DIR" ]; then
                echo "Gradle распакован в: $GRADLE_DIR"
                touch "$GRADLE_DIR/.gradle-8.5-all.zip.ok"
                break
              fi
            else
              echo "Не удалось скачать с $url"
            fi
          done
      
      - name: Install dependencies
        run: |
          echo "=== Установка зависимостей ==="
          flutter clean
          flutter pub get
          
          echo "Проверка Android проекта..."
          cd android
          ./gradlew --version || echo "Gradle версия недоступна"
          cd ..
      
      - name: Build APK Step by Step
        id: build-apk
        run: |
          echo "=== Поэтапная сборка APK ==="
          
          # 1. Проверка Flutter проекта
          echo "1. Проверка Flutter проекта..."
          flutter analyze || echo "Анализ завершился с предупреждениями"
          
          # 2. Сборка только Android части
          echo "2. Сборка Android проекта..."
          cd android
          
          echo "Очистка предыдущих сборок..."
          ./gradlew clean
          
          echo "Проверка доступности зависимостей..."
          ./gradlew --dry-run assembleRelease || true
          
          echo "Сборка в режиме debug для проверки..."
          if ./gradlew assembleDebug; then
            echo "✅ Debug сборка успешна"
            
            # Проверяем созданные файлы
            echo "Созданные файлы:"
            find . -name "*.apk" -type f 2>/dev/null || echo "APK не найдены"
            find . -name "*.aab" -type f 2>/dev/null || echo "AAB не найдены"
          else
            echo "❌ Debug сборка провалилась"
            exit 1
          fi
          
          echo "3. Сборка в режиме release..."
          if ./gradlew assembleRelease; then
            echo "✅ Release сборка успешна"
            
            # Проверяем release файлы
            echo "Release APK файлы:"
            find . -name "*release*.apk" -type f 2>/dev/null | head -10
            
            # Копируем найденный APK
            RELEASE_APK=$(find . -name "*release*.apk" -type f 2>/dev/null | head -1)
            if [ -n "$RELEASE_APK" ]; then
              echo "Найден Release APK: $RELEASE_APK"
              mkdir -p ../dist
              cp "$RELEASE_APK" "../dist/app-release.apk"
              echo "apk_path=dist/app-release.apk" >> $GITHUB_OUTPUT
            else
              echo "Release APK не найден, проверяем App Bundle..."
              find . -name "*.aab" -type f 2>/dev/null || echo "AAB также не найден"
            fi
          else
            echo "❌ Release сборка провалилась"
            exit 1
          fi
          
          cd ..
      
      - name: Upload APK Artifact
        if: steps.build-apk.outputs.apk_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: ${{ steps.build-apk.outputs.apk_path }}
          retention-days: 7
      
      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            android/**/build/reports/**
            android/**/*.log
          retention-days: 3
